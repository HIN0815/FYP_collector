AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
    API to collect lab data.
Globals:
  Function:
    Runtime: python3.6 # language used at runtime
    Timeout: 180 # timeout for a given lambda function execution
    MemorySize: 512
    Environment:
        Variables: 
          StudentLabDataBucket: !Ref StudentLabDataBucket
Resources:
    ApiGatewayApi:
      Type: AWS::Serverless::Api
      Properties:
        StageName: Prod
        DefinitionBody:
            swagger: 2.0
            info:
              title:
                Ref: AWS::StackName
            x-amazon-apigateway-api-key-source: "HEADER"
            paths:
              "/code":
                post:
                  security:
                    - api_key: []
                  x-amazon-apigateway-integration:
                    httpMethod: POST
                    type: aws_proxy
                    passthroughBehavior: "when_no_match"
                    uri:
                      Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LabCodeCollectorFunction.Arn}/invocations
                  responses: {}
              "/event":
                post:
                  security:
                    - api_key: []
                  x-amazon-apigateway-integration:
                    httpMethod: POST
                    type: aws_proxy
                    uri:
                      Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LabEventCollectorFunction.Arn}/invocations
                  responses: {}
            securityDefinitions:
              api_key:
                type: "apiKey"
                name: "x-api-key"
                in: "header"
                

    LabEventCollectorFunction:
        Type: AWS::Serverless::Function 
        Properties:
            CodeUri: venv/lib/python3.6/dist-packages
            Handler: collect_event_function.lambda_handler
            Policies:
              - Version: '2012-10-17'
                Statement:
                  - Effect: Allow
                    Action:
                      - apigateway:GET
                    Resource: 
                      Fn::Sub: 'arn:aws:apigateway:${AWS::Region}::/apikeys/*'
                  - Effect: Allow
                    Action:
                      - s3:PutObject
                    Resource:
                      Fn::Sub: 'arn:aws:s3:::${StudentLabDataBucket}/*'
            Events:
                LambdaMicroservice:
                  Type: Api
                  Properties:
                    RestApiId: !Ref ApiGatewayApi
                    Path: /event
                    Method: POST 

    LabCodeCollectorFunction:
        Type: AWS::Serverless::Function 
        Properties:
            CodeUri: venv/lib/python3.6/dist-packages
            Handler: collect_code_function.lambda_handler
            Policies:
              - Version: '2012-10-17'
                Statement:
                  - Effect: Allow
                    Action:
                      - apigateway:GET
                    Resource: 
                      Fn::Sub: 'arn:aws:apigateway:${AWS::Region}::/apikeys/*'
                  - Effect: Allow
                    Action:
                      - s3:PutObject
                    Resource:
                      Fn::Sub: 'arn:aws:s3:::${StudentLabDataBucket}/*'
            Events:
                LambdaMicroservice:
                  Type: Api
                  Properties:
                    RestApiId: !Ref ApiGatewayApi
                    Path: /code
                    Method: POST 
                    
    StudentLabDataBucket:
        Type: AWS::S3::Bucket
        Properties:
          VersioningConfiguration:
            Status: Enabled
        
    LabCodeCollectorFunctionPermission:
        Type: 'AWS::Lambda::Permission'
        Properties:
          Action: 'lambda:InvokeFunction'
          FunctionName:
            'Fn::GetAtt':
              - LabCodeCollectorFunction
              - Arn
          Principal: apigateway.amazonaws.com
          SourceArn:
            'Fn::Sub': 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/*/*/*'

    LabEventCollectorPermission:
        Type: 'AWS::Lambda::Permission'
        Properties:
          Action: 'lambda:InvokeFunction'
          FunctionName:
            'Fn::GetAtt':
              - LabEventCollectorFunction
              - Arn
          Principal: apigateway.amazonaws.com
          SourceArn:
            'Fn::Sub': 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:*/*/*/*'

    StudentPlan:
      Type: AWS::ApiGateway::UsagePlan
      DependsOn:
        - ApiGatewayApiProdStage
      Properties:
        ApiStages:
          -
            ApiId: !Ref 'ApiGatewayApi'
            Stage: Prod
        Description: Student Plan 50000 requests per day
        Quota:
          Limit: 50000
          Period: DAY
        Throttle:
          BurstLimit: 20
          RateLimit: 10
        UsagePlanName: STUDENT        

    ApiKey: 
      Type: AWS::ApiGateway::ApiKey
      DependsOn:
        - ApiGatewayApiProdStage
      Properties: 
        Name: TeacherApiKey
        Description: Teacher
        Enabled: "true"
        StageKeys: 
          - RestApiId: 
              Ref: "ApiGatewayApi"
            StageName: Prod
   
    UsagePlanKey:
      Type: AWS::ApiGateway::UsagePlanKey
      Properties : 
        KeyId: !Ref ApiKey
        KeyType: API_KEY
        UsagePlanId: !Ref StudentPlan 
      
Outputs:
    LabCollectorApi:
      Description: "API Gateway endpoint URL for Prod stage"
      Value: !Sub "https://${ApiGatewayApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
      
    LabEventCollectorApi:
      Description: "API Gateway endpoint URL for Prod stage for LabEventCollectorFunction function"
      Value: !Sub "https://${ApiGatewayApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/event/"

    LabCodeCollectorApi:
      Description: "API Gateway endpoint URL for Prod stage for LabEventCollectorFunction function"
      Value: !Sub "https://${ApiGatewayApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/code/"
      
    StudentPlan:
       Value: !Ref StudentPlan 
       
    StudentLabDataBucket:
      Value: !Ref StudentLabDataBucket 
      
    ApiKey:
      Value: !Ref ApiKey
